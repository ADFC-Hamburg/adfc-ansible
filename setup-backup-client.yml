- hosts: backup_clients
  roles:
  - load-contacts
  - ssh-keys
  - ubuntu-basic
  - vpnc
  tasks:

# benÃ¶tigte Programme installieren
  - name: Installiere Pakete
    apt:
      name: "{{ packages }}"
    vars:
      packages:
      - borgbackup
      - mailutils

#backup-script
  - name: create backup script from template
    template:
      src: backup-script_client.sh
      dest: /usr/local/sbin/backup-script_client.sh
      owner: root
      group: root
      mode: '0755'
    tags: script

  - name: cron erstellen # https://docs.ansible.com/ansible/latest/modules/cron_module.html?highlight=cron
    cron:
      name: "run-remote-backup"
      minute: "10"
      hour: "2"
      weekday: "2"
      cron_file: remote-backup
      user: root
      job: /usr/local/sbin/backup-script_client.sh

  - name: "Knock: Create ssh knocking-key"
    command: ssh-keygen -t rsa -b 4096 -f /root/.ssh/knocking-key -N '' -C 'knocking key {{ ansible_host }}'
    args:
      creates: /root/.ssh/knocking-key
    tags: knock

  - name: "Knock: Get Public Key"
    slurp:
      src: /root/.ssh/knocking-key.pub
    register: knock_ssh_pub
    tags: knock

  - name: "Knock: Set Knocking key to master"
    authorized_key:
      user: root
      comment: "ADFC-Ansible Knock {{ ansible_host }}"
      key: "{{ knock_ssh_pub.content | b64decode }}"
      state: present
      key_options: "restrict,command=\"echo $SSH_CLIENT |cut -d ' '  -f1 >/var/run/client-{{ ansible_hostname }}.up\""
    delegate_to: ucs-master.gst.hamburg.adfc.de
    tags: knock

  - name: "Copy knocking script"
    copy:
      src: knock-ssh.sh
      dest: /usr/local/sbin/adfc-knock
      mode: "0755"
    tags: knock

  - name: cron erstellen
    cron:
      name: "adfc-knock"
      minute: "*"
      cron_file: adfc-knock
      user: root
      job: /usr/local/sbin/adfc-knock
