- hosts: backup_clients
  roles:
  - load-contacts
  - ssh-keys
  - ubuntu-basic
  tasks:

# ben√∂tigte Programme installieren
  - name: Installiere Pakete
    apt:
      name: "{{ packages }}"
    vars:
      packages:
      - vpnc
      - borgbackup
      - mailutils

# vpnc-Konfiguration

  - name: Get vpnc.conf shared secret from master
    slurp:
      src: "{{ adfc_secret_folder + 'vpnc/' + ansible_hostname + '_vpnc_shared_secret' }}"
    delegate_to: "{{ adfc_vpnc_source }}"
    register: VPNC_SHARED_SECRET
    tags: vpnc

  - name: Get vpnc.conf password from master
    slurp:
      src: "{{ adfc_secret_folder + 'vpnc/' + ansible_hostname + '_vpnc_password' }}"
    delegate_to: "{{ adfc_vpnc_source }}"
    register: VPNC_PASSWORD
    tags: vpnc

#vpnc-Konfiguration
  - name: Erstelle /etc/vpnc/vpnc.conf
    template:
      src: vpnc.conf
      dest: /etc/vpnc/vpnc.conf
      owner: root
      group: root
      mode: '0600'
    tags: vpnc


#backup-script
  - name: create backup script from template
    template:
      src: backup-script_client.sh
      dest: /usr/local/sbin/backup-script_client.sh
      owner: root
      group: root
      mode: '0755'
    tags: script

  - name: cron erstellen # https://docs.ansible.com/ansible/latest/modules/cron_module.html?highlight=cron
    cron:
      name: "run-remote-backup"
      minute: "10"
      hour: "2"
      weekday: "2"
      cron_file: remote-backup
      user: root
      job: /usr/local/sbin/backup-script_client.sh

  - name: Create borgbackup user
    user:
      name: borguser
      comment: Borg Backup User
      system: yes
      password: '*'

  - name: Generate SSH Keys for borgbackup
    include_role:
      name: ssh-keys
    vars:
      authorized_key_user: borguser

  - name: Get Borgbackup key
    slurp:
       src: /root/.ssh/borgbackup-server.pub
    delegate_to: ucs-master.gst.hamburg.adfc.de
    register: borgbackupkey

  - name: Create Authorized_keys for borguser append
    authorized_key:
      user: borguser
      key: "{{ borgbackupkey.content |b64decode }}"
      state: present
      key_options: 'no-pty,no-agent-forwarding,no-port-forwarding,no-X11-forwarding,no-user-rc,from="192.168.123.32",command="borg serve --append-only --restrict-to-path /home/borguser/adfc-ucs-master/"'

  - name: Create Directory /home/borguser/adfc-ucs-master/
    file:
      path: /home/borguser/adfc-ucs-master/
      state: directory
      mode: 0700
      owner: borguser
      group: borguser

  - name: Mount Disk to /home/borguser/adfc-ucs-master/
    mount:
      path: /home/borguser/adfc-ucs-master/
      src: "{{ backup_disk_src }}"
      fstype: ext4
      state: mounted
      opts: noatime