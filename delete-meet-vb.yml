- name: Remove Videobridge
  hosts: jitsi_vbs
  gather_facts: no
  roles:
    - backup-hcloud-letsencrypt
  tasks:
    - name: make sure videobride on meet is running
      systemd:
        name: jitsi-videobridge2
        state: started
      delegate_to: "{{ jitsi_meet_server_name }}"

    - name: "stop videobride"
      systemd:
        name: jitsi-videobridge2
        state: stopped
      ignore_errors: yes
      ignore_unreachable: yes

    - name: Get hcloud API Token
      slurp:
        path: /root/hetzner-cloud.key
      register: hcloud_key_slurp
      delegate_to: proxmox01.adfc-intern.de

    - name: Setze hcloud_api_token
      set_fact:
        hcloud_api_token: "{{ hcloud_key_slurp.content | b64decode |trim }}"

    - name: Pause
      pause:
        seconds: 5

    - name: delete_host
      hcloud_server:
        api_token: "{{ hcloud_api_token }}"
        name: "{{ inventory_hostname }}"
        state: absent
      delegate_to: localhost

    - name: delete dns entry
      include_role:
        name: ucs_dns
      vars:
        ucs_dns_ips:
          - 127.0.0.1
          - ::1
        usc_dns_ttl_in_seconds: 60
        ucs_dns_waittime: 1