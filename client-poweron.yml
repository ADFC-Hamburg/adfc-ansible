- hosts: arbeitsplatz
  gather_facts: no

  tasks:
  - name: Check ob Client eingeschaltet
    wait_for_connection:
      timeout: 10
    register: connect_result
    ignore_errors: yes

  - name: Einschalten
    uri:
      url: http://{{ ansible_wireless_ps_host }}/cm?cmnd=Power+ON
    when:
      - ansible_wireless_ps_host is defined
      - connect_result is failed

  - name: Warten bis Rechner gestartet ist
    wait_for_connection:
      delay: 30
      timeout: 300
    register: after_start_connect_result
    when:
      - ansible_wireless_ps_host is defined
      - connect_result is failed

  - name: Fakten einlesen
    setup:
    when:
      - connect_result is not failed or after_start_connect_result is not failed
