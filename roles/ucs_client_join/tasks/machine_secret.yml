- name: Delete old machine.secret file if forced
  ansible.builtin.file:
    path: /etc/machine.secret
    state: absent
  when: ucs_client_join_force_new_machine_secret

- name: Check if Machine Secret already exists
  ansible.builtin.stat:
    path: /etc/machine.secret
  register: machine_secret

- name: Read machine secret from file
  ansible.builtin.slurp:
    path: /etc/machine.secret
  register: machine_secret_content
  when: machine_secret.stat.exists

- name: Generate machine secret fact
  ansible.builtin.set_fact:
    ucs_client_join_machine_secret: >-
      {%- if machine_secret.stat.exists -%}
        {{ machine_secret_content.content | b64decode }}
      {%- else -%}
        {{ lookup('password', '/dev/null length=' + ucs_client_join_machine_secret_length | string + ' chars=ascii_letters,digits,.-_()[]ยง') }}
      {%- endif -%}
- name: Generate Machine Password File
  ansible.builtin.copy:
    content: "{{ ucs_client_join_machine_secret | trim }}"
    dest: /etc/machine.secret
    mode: "0400"
    owner: root
    group: root
