- name: Read Root Password from proxmox01
  slurp:
    path: "/root/root.secret"
  register: root_secret
  delegate_to: proxmox01.adfc-intern.de

- name: set vars
  set_fact:
    ucs_password: "{{ root_secret.content |b64decode |trim }}"
    dyndns_different: false
    zonettl: 60
    dns_entry_dn: "{{ 'relativeDomainName=' + inventory_hostname.replace('.'+hcloud_dyndns_domain,'') + ',zoneName='+ hcloud_dyndns_domain +',' + ucs_dns }}"
  delegate_to: localhost


- name: Get entry
  uri:
    headers:
      Accept: application/json
    url: "https://int-master.adfc-intern.de/univention/udm/dns/host_record/{{ dns_entry_dn |urlencode }}"
    url_username: "Administrator"
    url_password: "{{ ucs_password }}"
    status_code:
      - 200
      - 404
  register: dyndns_read_entry
  delegate_to: localhost

- name: Change entry
  uri:
    headers:
      Accept: application/json
    url: "https://int-master.adfc-intern.de/univention/udm/dns/host_record/{{ dns_entry_dn |urlencode }}"
    url_username: "Administrator"
    url_password: "{{ ucs_password }}"
    method: PUT
    body_format: json
    status_code:
      - 200
      - 204
    body:
      position: "{{ 'zoneName='+ hcloud_dyndns_domain +',' + ucs_dns }}"
      properties:
        a:
          - "{{ hcloud_host.hcloud_server.ipv4_address }}"
          - "{{ hcloud_host.hcloud_server.ipv6_address }}"
        zonettl: "{{ zonettl }}"
        mx: []
        txt: []
        name: "{{ inventory_hostname.replace('.'+hcloud_dyndns_domain,'') }}"
  when:
    - ( dyndns_read_entry.status == 200)
    - (( dyndns_read_entry.json.properties.a | map('ipaddr','int') |list |sort |join(',') )  !=
      ( [ hcloud_host.hcloud_server.ipv4_address, ( hcloud_host.hcloud_server.ipv6 |replace('/64', '1') ) ]  | map('ipaddr','int') |list |sort |join(',') )) or
      ( zonettl != dyndns_read_entry.json.properties.zonettl)

- name: Create entry
  uri:
    headers:
      Accept: application/json
    url: "https://int-master.adfc-intern.de/univention/udm/dns/host_record/"
    url_username: "Administrator"
    url_password: "{{ ucs_password }}"
    method: POST
    body_format: json
    status_code:
      - 200
      - 201
    body:
      position: "{{ 'zoneName='+ hcloud_dyndns_domain +',' + ucs_dns }}"
      properties:
        a:
          - "{{ hcloud_host.hcloud_server.ipv4_address }}"
          - "{{ hcloud_host.hcloud_server.ipv6 | replace('/64','1') }}"
        zonettl: "{{ zonettl }}"
        mx: []
        txt: []
        name: "{{ inventory_hostname.replace('.'+hcloud_dyndns_domain,'') }}"
  when:
    - ( dyndns_read_entry.status == 404)
  delegate_to: localhost

- name: Wait TTL
  pause:
    seconds: "{{ zonettl }}"
  delegate_to: localhost
