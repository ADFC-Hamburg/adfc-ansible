---
- name: Install required APT packages
  ansible.builtin.apt:
    name: "{{ packages }}"
  vars:
    packages:
      - python3
      - python3-pip
      - python3-tk
      - python3-venv

- name: Download code from github to local machine
  delegate_to: localhost
  run_once: true
  ansible.builtin.get_url:
    url: "https://github.com/ADFC-Hamburg/telefonanalyse/archive/refs/tags/{{ tag }}.tar.gz"
    dest: "/tmp/telefonanalyse-{{ tag }}.tar.gz"
    checksum: sha256:2c1c717cde7cb557bfc1433e3b7b00c55ae8d609e212a7af03e9680ed99287bc
  vars:
    tag: v2025-07-08.1
  register: telefonanalyse_archive

- name: Create program directory
  ansible.builtin.file:
    path: /opt/telefonanalyse
    state: directory
    mode: 0755
  register: telefonanalyse_programdir

- name: Unpack code to program directory
  ansible.builtin.unarchive:
    src: "{{ telefonanalyse_archive.dest }}"
    dest: "{{ telefonanalyse_programdir.path }}"
    extra_opts: ['--strip-components=1', '--show-stored-names']

- name: Create virtual environment
  ansible.builtin.command:
    cmd: "python3 -m venv {{ telefonanalyse_programdir.path }}/.venv"
    creates: "{{ telefonanalyse_programdir.path }}/.venv/bin/python3"

- name: Install required Python packages
  ansible.builtin.command:
    cmd: "{{ telefonanalyse_programdir.path }}/.venv/bin/pip install -r {{ telefonanalyse_programdir.path }}/requirements.txt"

- name: Set permissions on virtual environment folder
  ansible.builtin.file:
    path: "{{ telefonanalyse_programdir.path }}/.venv"
    recurse: yes
    mode: 0755

- name: Create and set permissions for applications folder
  ansible.builtin.file:
    path: /usr/local/share/applications
    state: directory
    mode: 0755

- name: Copy .desktop file into applications folder
  ansible.builtin.copy:
    src: adfc-telefonanalyse.desktop
    dest: /usr/local/share/applications/adfc-telefonanalyse.desktop
    mode: 0644
