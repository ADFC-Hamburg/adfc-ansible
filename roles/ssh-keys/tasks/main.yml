---
- name: include adfc-secrets/adfc-hh-users.sec.yml
  include_vars: "{{ playbook_dir }}/adfc-secrets/adfc-hh-users.sec.yml"

- name: search for excluded direcories
  local_action:
     module: find
     path: "{{ inventory_dir + '/' + key_path }}"
     recurse: no
     file_type: directory
     excludes: "{{ ssh_users_admins |join(',') }}"
  register: remove_keys_path

- name: search for files in excluded dirs
  local_action:
     module: find
     path: "{{ remove_keys_path| json_query('files[*].path') }}"
     recurse: yes
     file_type: file
  register: remove_keys_files

- name: search for included files
  local_action:
     module: find
     paths: "{{ inventory_dir + '/' + key_path + item  }}"
     recurse: yes
     file_type: file
     excludes: "{{ ssh_users_admins |join(',') }}"
  with_items: "{{ ssh_users_admins }}"
  register: add_keys_files

- name: add ssh keys of the admins
  authorized_key:
      user: root
      comment: "ADFC-Ansible {{ item | relpath(inventory_dir + '/' + key_path) }}"
      key: "{{ lookup('file', item) }}"
      state: present
  with_items: "{{ add_keys_files |json_query('results[*].files[*].path')  }}"


- name: remove all ssh keys that don't belong to the admins list
  authorized_key:
      user: root
      key: "{{ lookup('file', item.path) }}"
      state: absent
  with_items: "{{ remove_keys_files.files }}"
