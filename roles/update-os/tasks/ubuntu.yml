---
- name: Update all packages to the latest version
  ansible.builtin.apt:
    upgrade: dist
    update_cache: true

- name: Remove useless packages from the cache
  ansible.builtin.apt:
    autoclean: true

- name: Check if a reboot is required
  ansible.builtin.stat:
    path: /var/run/reboot-required
    get_md5: false
  register: reboot_required_file

- name: check logged on users
  ansible.builtin.command: who
  register: who_var
  changed_when: false

- name: parse output
  ansible.builtin.set_fact:
    users: '{{ who_var.stdout_lines | reject("match", "^root ") | list }}'

- name: Reboot when no user but root is connected
  reboot:
  when:
    - reboot_required_file.stat.exists
    - (users is defined) and (users | length == 0)
