- name: Create Sysmlink to wartung
  ansible.builtin.file:
    src: /etc/nginx/sites-available/{{ rocketchat_server_name }}-wartung.conf
    dest: /etc/nginx/sites-enabled/{{ rocketchat_server_name }}-wartung.conf
    state: link

- name: Delete normal chat site
  ansible.builtin.file:
    path: /etc/nginx/sites-enabled/{{ rocketchat_server_name }}.conf
    state: absent

- name: Restart nginx
  ansible.builtin.systemd:
    name: nginx.service
    state: restarted

- name: Stop Docker Compose stack
  community.docker.docker_compose:
    project_src: "{{ docker_rocketchat_dir }}"
    state: absent
    files:
      - compose.yml
  tags:
    - compose

- name: Create LVM Snapshot
  ansible.builtin.command:
    argv:
      - lvcreate
      - -L
      - 2G
      - -s
      - -n
      - var-lib-docker-snap-ansible
      - /dev/chat2vg/var-lib-docker

- name: Start Docker Compose stack
  community.docker.docker_compose:
    project_src: "{{ docker_rocketchat_dir }}"
    files:
      - compose.yml
  tags:
    - compose

- name: Test Rocketchat
  ansible.builtin.pause:
    prompt: |
      Bitte Rocketchat testen:
      Portforward:
        ssh -L 3000:127.0.0.1:3000 root@{{ inventory_hostname }}
      Und dann auf
        http://127.0.0.1:3000
      Wenn etwas nicht klappt, kann das hier mit Strg-C abgebrochen
      und auf den LVM Snapshot var-lib-docker-snap-ansible zur√ºck gegangen werden

- name: Delete LVM Snapshot
  ansible.builtin.command:
    argv:
      - lvremove
      - -f
      - /dev/chat2vg/var-lib-docker-snap-ansible

- name: Create Sysmlink to main site
  ansible.builtin.file:
    src: /etc/nginx/sites-available/{{ rocketchat_server_name }}.conf
    dest: /etc/nginx/sites-enabled/{{ rocketchat_server_name }}.conf
    state: link

- name: Delete wartung  site
  ansible.builtin.file:
    path: /etc/nginx/sites-enabled/{{ rocketchat_server_name }}-wartung.conf
    state: absent

- name: Restart nginx
  ansible.builtin.systemd:
    name: nginx.service
    state: restarted
