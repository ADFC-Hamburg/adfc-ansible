- name: Setup packages
  apt:
    name:
      - nginx
    state: present

- name: Create a directory if it does not exist
  ansible.builtin.file:
    path: "{{ docker_rocketchat_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Copy rocketchat docker-compose.yml
  copy:
    src: compose.yml
    dest: "{{ docker_rocketchat_dir }}/compose.yml"
    mode: 0644
    owner: root
    group: root

- name: Create env file
  template:
    src: docker-env.j2
    dest: "{{ docker_rocketchat_dir }}/.env"
    mode: 0644
    owner: root
    group: root
  register: docker_env

# use files parameter to use multiple docker-compose.yml files
- name: deploy Docker Compose stack
  docker_compose:
    project_src: "{{ docker_rocketchat_dir }}"
    files:
      - compose.yml
  tags:
    - compose

- name: Create a directory if it does not exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  loop:
    - /var/www/chat-wartung
    - /var/www/empty
  tags:
    - nginx

- name: Copy wartung.html
  ansible.builtin.copy:
    src: wartung.html
    dest: /var/www/chat-wartung/wartung.html
    mode: 0644
    owner: root
    group: root
  tags:
    - nginx

- name: Setup nginx Site
  template:
    src: nginx-site.conf.j2
    dest: /etc/nginx/sites-available/{{ rocketchat_server_name }}.conf
  notify:
    - restart nginx
  tags:
    - nginx

- name: Setup nginx Wartung Site
  template:
    src: nginx-site-wartung.conf.j2
    dest: /etc/nginx/sites-available/{{ rocketchat_server_name }}-wartung.conf
  notify:
    - restart nginx
  tags:
    - nginx

- name: Delete default site
  file:
    path: /etc/nginx/sites-enabled/default.conf
    state: absent
  notify:
    - restart nginx
  tags:
    - nginx

- name: Create Sysmlink
  file:
    src: /etc/nginx/sites-available/{{ rocketchat_server_name }}.conf
    dest: /etc/nginx/sites-enabled/{{ rocketchat_server_name }}.conf
    state: link
  notify:
    - restart nginx
  tags:
    - nginx_synlink

- name: Include New Version
  include_tasks: new_version.yml
